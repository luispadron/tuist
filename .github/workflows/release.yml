name: Tuist Release

on:
  page_build:
  release:
    types:
      - published

env:
  RUBY_VERSION: '3.0.2'
  TUIST_STATS_OPT_OUT: true
  VERSION: ${{ github.event.release.tag_name }}

jobs:
  release:
    runs-on: macos-latest
    steps:
    - uses: actions/checkout@v2
    - uses: ruby/setup-ruby@v1
      with:
        ruby-version: ${{ env.RUBY_VERSION }}
    - uses: actions/cache@v2
      with:
        path: vendor/bundle
        key: ${{ runner.os }}-${{ env.RUBY_VERSION }}-gems-${{ hashFiles('**/Gemfile.lock') }}
        restore-keys: |
          ${{ runner.os }}-${{ env.RUBY_VERSION }}-gems-
    - name: Bundle install
      run: |
        bundle config path vendor/bundle
        bundle install --jobs 4 --retry 3
    - name: Update Tuist version
      run: sed -i '' -e "s/version = \"development\"/version = \"${{ env.VERSION }}\"/g" Sources/TuistSupport/Constants.swift
    - name: Fourier releae
      run: ./fourier release tuist ${{ env.VERSION }}
    - name: Upload release binaries
      uses: alexellis/upload-assets@0.2.2
      env:
        GITHUB_TOKEN: ${{ github.token }}
      with:
        asset_paths: '["build/*"]'
